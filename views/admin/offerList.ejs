<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeatWorld | Offer Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/admin/offerList.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-100 font-sans">
    <%- include('../partials/adminHeader') %>
        <div class="flex pt-16 min-h-screen">
            <!-- Sidebar -->
            <%- include('../partials/adminSidebar') %>

                <!-- Main Content -->
                <main class="flex-1 p-8">
                    <div class="max-w-6xl mx-auto">
                        <!-- Offer Header -->
                        <div class="offer-header">
                            <h1>Offers</h1>
                            <div class="header-actions">
                                <div class="search-box">
                                    <span class="material-icons-outlined search-icon">search</span>
                                    <form action="/admin/offers" method="GET" class="flex-1">
                                        <input type="text" name="search" placeholder="Search for Categories"
                                            value="<%= search %>">
                                    </form>
                                </div>
                                <button class="btn-add" onclick="window.location.href='/admin/offers/add'">
                                    Add New Offer
                                </button>
                            </div>
                        </div>

                        <!-- Offers Table -->
                        <div class="offers-table-container">
                            <table class="offers-table">
                                <thead>
                                    <tr>
                                        <th>Sl.No</th>
                                        <th>Offer Type</th>
                                        <th>Offer For</th>
                                        <th>Discount percentage</th>
                                        <th>Edit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (offers && offers.length> 0) { %>
                                        <% offers.forEach((offer, index)=> { %>
                                            <tr>
                                                <td>
                                                    <%= (pagination.currentPage - 1) * 8 + index + 1 %>
                                                </td>
                                                <td>
                                                    <%= offer.offerType %>
                                                </td>
                                                <td>
                                                    <%= offer.offerType==='Product' ? (offer.productId ?
                                                        offer.productId.name : 'Unknown Product' ) : (offer.categoryId ?
                                                        offer.categoryId.categoryName : 'Unknown Category' ) %>
                                                </td>
                                                <td class="discount-text">
                                                    <%= offer.discountPercentage %>%
                                                </td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <button class="btn-edit"
                                                            onclick="window.location.href='/admin/offers/edit/<%= offer._id %>'">Edit</button>
                                                        <button class="btn-block"
                                                            onclick="toggleOfferStatus('<%= offer._id %>', '<%= offer.isActive ? 'Block' : 'Unblock' %>')">
                                                            <%= offer.isActive ? 'Block' : 'Unblock' %>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="5" class="py-10 text-gray-500 font-medium">No
                                                            offers
                                                            found</td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>

                            <!-- Pagination -->
                            <div class="mt-8">
                                <%- include('../partials/pagination', { pagination: pagination, query: search
                                    ? 'search=' + search : '' }) %>
                            </div>
                        </div>
                    </div>
                </main>
        </div>

        <script>
            async function toggleOfferStatus(offerId, statusText) {
                const result = await Swal.fire({
                    title: 'Are you sure?',
                    text: `Do you want to ${statusText.toLowerCase()} this offer?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: statusText === 'Block' ? '#b71c1c' : '#1b5e20',
                    cancelButtonColor: '#9e9e9e',
                    confirmButtonText: `Yes, ${statusText} it!`
                });

                if (result.isConfirmed) {
                    try {
                        const response = await fetch(`/admin/offers/${offerId}/toggle`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: data.message,
                                timer: 1500,
                                showConfirmButton: false
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    } catch (error) {
                        console.error('Error toggling offer status:', error);
                        Swal.fire('Error', 'Something went wrong', 'error');
                    }
                }
            }
        </script>
</body>

</html>