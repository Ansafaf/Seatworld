<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SeatWorld - Product Gallery</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-800: #1e293b;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --max-width: 1200px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--slate-50);
      color: var(--slate-800);
      line-height: 1.5;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* --- LAYOUT --- */
    .layout {
      max-width: var(--max-width);
      margin: 2rem auto;
      padding: 0 1.5rem;
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 3rem;
    }

    /* --- SIDEBAR --- */
    .filters-sidebar {
      position: sticky;
      top: 5.5rem;
      height: fit-content;
    }

    .filter-section {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--slate-200);
    }

    .filter-section:last-child {
      border-bottom: none;
    }

    .filter-title {
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 1.25rem;
      color: var(--slate-800);
    }

    /* Price Range */
    .price-inputs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
    }

    .price-input-group {
      flex: 1;
    }

    .price-input-group label {
      display: block;
      font-size: 0.7rem;
      color: var(--slate-500);
      margin-bottom: 0.25rem;
    }

    .price-input-group input {
      width: 100%;
      padding: 0.4rem;
      border: 1px solid var(--slate-200);
      border-radius: 6px;
      font-size: 0.8rem;
      outline: none;
      background: var(--slate-100);
    }

    .range-slider {
      position: relative;
      height: 4px;
      background: var(--slate-200);
      border-radius: 999px;
      margin: 1.5rem 0;
    }

    .range-slider .progress {
      position: absolute;
      height: 100%;
      background: var(--primary);
      border-radius: 999px;
    }

    .range-slider input {
      position: absolute;
      width: 100%;
      height: 4px;
      top: -4px;
      background: none;
      pointer-events: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .range-slider input::-webkit-slider-thumb {
      height: 16px;
      width: 16px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid var(--primary);
      pointer-events: auto;
      -webkit-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    /* Checkbox lists */
    .filter-list {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .filter-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--slate-600);
    }

    .filter-item input {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    /* Color */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(28px, 1fr));
      gap: 0.5rem;
    }

    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      position: relative;
    }

    .color-swatch input {
      position: absolute;
      opacity: 0;
    }

    .color-swatch.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px #fff, 0 0 0 4px var(--primary);
    }

    /* --- MAIN AREA --- */
    .results-section {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .results-header {
      margin-bottom: 2rem;
    }

    .heading h1 {
      font-size: 2.25rem;
      font-weight: 700;
      color: var(--slate-800);
    }

    .heading p {
      color: var(--slate-500);
      font-size: 1rem;
    }

    .sort-bar {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-width: 320px;
    }

    .sort-bar label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--slate-600);
    }

    .sort-select {
      padding: 0.75rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--slate-200);
      background: #fff;
      font-size: 0.9rem;
      outline: none;
      cursor: pointer;
    }

    /* --- PRODUCT GRID --- */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 2.5rem 1.75rem;
    }

    .product-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--slate-100);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .product-card.out-of-stock {
      opacity: 0.7;
    }

    .product-card.out-of-stock .product-media::after {
      content: 'OUT OF STOCK';
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--slate-700);
      font-weight: 800;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }

    .product-media {
      background: #f1f5f9;
      border-radius: 12px;
      aspect-ratio: 1;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      position: relative;
    }

    .product-media img {
      width: 85%;
      height: 85%;
      object-fit: contain;
      mix-blend-mode: multiply;
    }

    .off-badge {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      background: #fff;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--primary);
    }

    .product-info h3 {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }

    .price-info {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .p-current {
      font-weight: 700;
      font-size: 1rem;
    }

    .p-old-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .p-old {
      color: var(--slate-400);
      text-decoration: line-through;
    }

    .p-off {
      color: var(--primary);
      font-weight: 600;
    }

    .stock-status {
      font-size: 0.8rem;
      margin-top: 0.4rem;
    }

    /* --- PAGINATION --- */
    .pagination-container {
      margin-top: 4rem;
      padding-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2.5rem;
    }

    .page-node {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 500;
      color: #334155;
      transition: all 0.2s;
      text-decoration: none;
    }

    .page-node.active {
      background: #eaeff4;
      color: #000;
      font-weight: 700;
      width: 56px;
      height: 56px;
      border-radius: 50%;
    }

    .page-node:hover:not(.active) {
      color: var(--primary);
    }

    .page-node.disabled {
      opacity: 0.3;
      pointer-events: none;
    }

    .pagination-info {
      font-size: 0.9rem;
      color: var(--slate-500);
    }

    /* --- FOOTER --- */
    footer {
      background: #fff;
      border-top: 1px solid var(--slate-200);
      padding: 5rem 1.5rem 2rem;
      margin-top: 6rem;
    }

    .footer-links {
      display: flex;
      justify-content: center;
      gap: 4rem;
      margin-bottom: 3rem;
    }

    .footer-links a {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--slate-500);
    }

    .footer-links a:hover {
      color: var(--primary);
    }

    .footer-bottom {
      max-width: var(--max-width);
      margin: 0 auto;
      border-top: 1px solid var(--slate-100);
      padding-top: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
    }

    .social-icons {
      display: flex;
      gap: 1.5rem;
      color: var(--slate-400);
    }

    .copyright {
      font-size: 0.85rem;
      color: var(--slate-400);
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 1024px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .filters-sidebar {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .footer-links {
        flex-wrap: wrap;
        gap: 2rem;
      }
    }
  </style>
</head>

<body>
  <!-- Integrated Header Partial -->
  <%- include('../partials/header', { showSearch: true }) %>

    <%- include('../partials/flash') %>
      <%- include("../partials/breadcrumb", { breadcrumbs }) %>


        <main class="layout">
          <!-- Sidebar -->
          <aside class="filters-sidebar">
            <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem;">Filters</h2>

            <form id="productFilters" action="/products" method="GET">
              <input type="hidden" name="search" value="<%= filters?.search || '' %>">

              <div class="filter-section">
                <h3 class="filter-title">Price Range</h3>
                <div class="price-inputs">
                  <div class="price-input-group">
                    <label>Min</label>
                    <input type="number" id="minPriceInput" name="minPrice"
                      value="<%= filters?.minPrice || priceRange?.min || 0 %>">
                  </div>
                  <div class="price-input-group">
                    <label>Max</label>
                    <input type="number" id="maxPriceInput" name="maxPrice"
                      value="<%= filters?.maxPrice || priceRange?.max || 5000 %>">
                  </div>
                </div>
                <div class="range-slider">
                  <div class="progress" id="priceProgress"></div>
                  <input type="range" id="minRange" min="<%= priceRange?.min || 0 %>"
                    max="<%= priceRange?.max || 5000 %>" value="<%= filters?.minPrice || priceRange?.min || 0 %>"
                    step="10">
                  <input type="range" id="maxRange" min="<%= priceRange?.min || 0 %>"
                    max="<%= priceRange?.max || 5000 %>" value="<%= filters?.maxPrice || priceRange?.max || 5000 %>"
                    step="10">
                </div>
              </div>

              <div class="filter-section">
                <h3 class="filter-title">Brand</h3>
                <div class="filter-list">
                  <% if (brands && brands.length) { %>
                    <% brands.forEach(brand=> { %>
                      <label class="filter-item">
                        <input type="checkbox" name="brand" value="<%= brand %>" <%=filters?.brands?.includes(brand)
                          ? 'checked' : '' %>>
                        <span>
                          <%= brand %>
                        </span>
                      </label>
                      <% }) %>
                        <% } %>
                </div>
              </div>

              <div class="filter-section">
                <h3 class="filter-title">Category</h3>
                <div class="filter-list">
                  <% if (categories && categories.length) { %>
                    <% categories.forEach(cat=> { %>
                      <label class="filter-item">
                        <input type="checkbox" name="category" value="<%= cat._id %>"
                          <%=filters?.categories?.includes(cat._id.toString()) ? 'checked' : '' %>>
                        <span>
                          <%= cat.categoryName %>
                        </span>
                      </label>
                      <% }) %>
                        <% } %>
                </div>
              </div>

              <div class="filter-section">
                <h3 class="filter-title">Color</h3>
                <div class="color-grid">
                  <% if (colors && colors.length) { %>
                    <% colors.forEach(color=> { %>
                      <label class="color-swatch <%= filters?.colors?.includes(color) ? 'active' : '' %>"
                        style="background-color: <%= color.toLowerCase() %>;" title="<%= color %>">
                        <input type="checkbox" name="color" value="<%= color %>" <%=filters?.colors?.includes(color)
                          ? 'checked' : '' %> onchange="this.parentElement.classList.toggle('active')">
                      </label>
                      <% }) %>
                        <% } %>
                </div>
              </div>

              <button type="submit"
                style="width: 100%; padding: 0.75rem; background: var(--slate-800); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 1rem;">Apply</button>
            </form>
          </aside>

          <!-- Main Content -->
          <section class="results-section">
            <div class="results-header">
              <div class="heading">
                <h1>
                  <%= filters?.heading || 'Chairs' %>
                </h1>
                <p>
                  <%= pagination?.totalItems || 0 %> results found
                </p>
              </div>

              <div class="sort-bar">
                <label>Sort By</label>
                <select class="sort-select" name="sort" form="productFilters" onchange="this.form.submit()">
                  <option value="featured" <%=filters?.sort==='featured' ? 'selected' : '' %>>Featured</option>
                  <option value="newest" <%=filters?.sort==='newest' ? 'selected' : '' %>>Latest Arrivals</option>
                  <option value="name" <%=filters?.sort==='name' ? 'selected' : '' %>>A to Z</option>
                  <option value="price-high" <%=filters?.sort==='price-high' ? 'selected' : '' %>>Price: High to Low
                  </option>
                  <option value="price-low" <%=filters?.sort==='price-low' ? 'selected' : '' %>>Price: Low to High
                  </option>
                </select>
              </div>
            </div>

            <!-- Grid -->
            <div class="products-grid">
              <% if (products && products.length) { %>
                <% products.forEach(product=> { %>
                  <% const currentPrice=product.variant?.price || product.Baseprice; const isOnSale=currentPrice <
                    product.Baseprice; const offPercent=isOnSale ? Math.round((1 - currentPrice / product.Baseprice) *
                    100) : 0; %>
                    <a href="/product/<%= product._id %>"
                      class="product-card <%= product.stock <= 0 ? 'out-of-stock' : '' %>">
                      <div class="product-media">
                        <img src="<%= product.image || 'https://via.placeholder.com/400?text=SeatWorld' %>"
                          alt="<%= product.name %>">
                        <% if (isOnSale) { %>
                          <div class="off-badge">
                            <%= offPercent %>% off
                          </div>
                          <% } %>
                      </div>
                      <div class="product-info">
                        <h3>
                          <%= product.name %>
                        </h3>
                        <div class="price-info">
                          <% if (isOnSale) { %>
                            <div class="p-current">₹<%= Number(currentPrice).toLocaleString('en-IN') %>
                            </div>
                            <div class="p-old-row">
                              <span class="p-old">₹<%= Number(product.Baseprice).toLocaleString('en-IN') %></span>
                              <span class="p-off">
                                <%= offPercent %>% off
                              </span>
                            </div>
                            <% } else { %>
                              <div class="p-current">₹<%= Number(product.Baseprice).toLocaleString('en-IN') %>
                              </div>
                              <% } %>
                        </div>
                        <div class="stock-status" style="color: <%= product.stock > 0 ? '#10b981' : '#ef4444' %>">
                          <%= product.stock> 0 ? 'In Stock' : 'Out of Stock' %>
                        </div>
                      </div>
                    </a>
                    <% }) %>
                      <% } else { %>
                        <div
                          style="grid-column: 1/-1; text-align: center; padding: 4rem; background: #fff; border-radius: 12px;">
                          <p style="color: var(--slate-400);">No products match your criteria.</p>
                        </div>
                        <% } %>
            </div>

            <!-- Pagination -->
            <div class="pagination-container">
              <% if (pagination && pagination.totalItems> 0) { %>
                <div class="pagination">
                  <% if (pagination.totalPages> 1) { %>
                    <a href="?page=<%= pagination.currentPage - 1 %>&<%= query %>"
                      class="page-node <%= !pagination.hasPrev ? 'disabled' : '' %>" aria-label="Previous">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                      </svg>
                    </a>

                    <% const current=pagination.currentPage; const total=pagination.totalPages; const delta=2; let
                      pagesList=[]; for (let i=1; i <=total; i++) { if (i===1 || i===total || (i>= current - delta && i
                      <= current + delta)) { pagesList.push(i); } else if (pagesList[pagesList.length-1] !=='...' ) {
                        pagesList.push('...'); } } %>

                        <% pagesList.forEach(p=> { %>
                          <% if (p==='...' ) { %>
                            <span style="color: var(--slate-400)">...</span>
                            <% } else { %>
                              <a href="?page=<%= p %>&<%= query %>"
                                class="page-node <%= p === current ? 'active' : '' %>">
                                <%= p %>
                              </a>
                              <% } %>
                                <% }) %>

                                  <a href="?page=<%= pagination.currentPage + 1 %>&<%= query %>"
                                    class="page-node <%= !pagination.hasNext ? 'disabled' : '' %>" aria-label="Next">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                      <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                  </a>
                                  <% } else { %>
                                    <!-- Minimal pagination for single page to reassure user -->
                                    <span class="page-node active">1</span>
                                    <% } %>
                </div>
                <div class="pagination-info">
                  Showing <%= Math.min(pagination.totalItems, (pagination.currentPage - 1) * pagination.itemsPerPage +
                    1) %>-<%= Math.min(pagination.totalItems, pagination.currentPage * pagination.itemsPerPage) %> of
                      <%= pagination.totalItems %> products
                </div>
                <% } %>
            </div>
          </section>
        </main>

        <!-- Footer -->
        <footer>
          <div class="footer-links">
            <a href="/about">About Us</a>
            <a href="#">Contact</a>
            <a href="#">FAQ</a>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms of Service</a>
          </div>
          <div class="footer-bottom">
            <div class="social-icons">
              <span>Twitter</span>
              <span>Instagram</span>
              <span>Facebook</span>
            </div>
            <div class="copyright">© <%= new Date().getFullYear() %> SeatWorld. All rights reserved.</div>
          </div>
        </footer>

        <script>
          // Price Range Sync
          const minRange = document.getElementById('minRange');
          const maxRange = document.getElementById('maxRange');
          const minInput = document.getElementById('minPriceInput');
          const maxInput = document.getElementById('maxPriceInput');
          const progress = document.getElementById('priceProgress');

          function updateSlider() {
            if (!minRange) return;
            const min = parseInt(minRange.min);
            const max = parseInt(minRange.max);
            const minVal = parseInt(minRange.value);
            const maxVal = parseInt(maxRange.value);

            if (maxVal - minVal < 100) {
              if (event && event.target === minRange) minRange.value = maxVal - 100;
              else if (event && event.target === maxRange) maxRange.value = minVal + 100;
            }

            const cMin = parseInt(minRange.value);
            const cMax = parseInt(maxRange.value);

            minInput.value = cMin;
            maxInput.value = cMax;

            const p1 = ((cMin - min) / (max - min)) * 100;
            const p2 = ((cMax - min) / (max - min)) * 100;

            progress.style.left = p1 + '%';
            progress.style.width = (p2 - p1) + '%';
          }

          if (minRange) {
            minRange.addEventListener('input', updateSlider);
            maxRange.addEventListener('input', updateSlider);
            minInput.addEventListener('change', () => { minRange.value = minInput.value; updateSlider(); });
            maxInput.addEventListener('change', () => { maxRange.value = maxInput.value; updateSlider(); });
            updateSlider();
          }
        </script>
</body>

</html>