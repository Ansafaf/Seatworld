<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details | SeatWorld</title>
    <link rel="stylesheet" href="/css/users/profile.css">
    <link rel="stylesheet" href="/css/users/orderDetails.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
    <%- include('../partials/header', { showSearch: false }) %>
        <%- include("../partials/breadcrumb", { breadcrumbs }) %>
            <%- include("../partials/flash", { messageData: locals.message }) %>

                <%- include('../partials/profileMobileToggle') %>

                    <div class="profile-container">
                        <div class="profile-layout">
                            <!-- SIDEBAR -->
                            <%- include('../partials/profileSidebar', { active: 'orders' }) %>

                                <!-- CONTENT -->
                                <main class="main-content">
                                    <div class="order-details-container">
                                        <!-- Order Header -->
                                        <div class="order-header-section">
                                            <div class="order-info">
                                                <h1>Order #<%= order._id.toString().slice(-6).toUpperCase() %>
                                                </h1>
                                                <p>Placed on <%= new Date(order.createdAt).toLocaleDateString('en-GB', {
                                                        day: '2-digit' , month: 'long' , year: 'numeric' }) %>
                                                </p>
                                            </div>
                                            <div class="header-actions">
                                                <a href="/orders/<%= order._id %>/invoice" class="btn-download">
                                                    <i class="fas fa-file-invoice"></i> Download Invoice
                                                </a>
                                                <span
                                                    class="status-badge status-<%= (order.orderStatus || 'pending').toLowerCase() %>">
                                                    <%= order.orderStatus || 'Pending' %>
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Info Grid -->
                                        <div class="info-grid">
                                            <!-- Shipping -->
                                            <div class="info-section">
                                                <h3>Shipping Address</h3>
                                                <div class="info-content">
                                                    <strong>
                                                        <%= order.shippingAddress.name %>
                                                    </strong>
                                                    <p>
                                                        <%= order.shippingAddress.housename %>, <%=
                                                                order.shippingAddress.street %>
                                                    </p>
                                                    <p>
                                                        <%= order.shippingAddress.city %>, <%=
                                                                order.shippingAddress.state %>
                                                                <%= order.shippingAddress.pincode %>
                                                    </p>
                                                    <p>
                                                        <%= order.shippingAddress.country %>
                                                    </p>
                                                    <p style="margin-top: 8px;">Phone: <%= order.shippingAddress.mobile
                                                            %>
                                                    </p>
                                                </div>
                                            </div>

                                            <!-- Payment -->
                                            <div class="info-section">
                                                <h3>Payment Details</h3>
                                                <div class="info-content">
                                                    <div class="payment-item">
                                                        <span class="payment-label">Method</span>
                                                        <span class="payment-value">
                                                            <%= order.paymentMethod %>
                                                        </span>
                                                    </div>
                                                    <div class="payment-item">
                                                        <span class="payment-label">Status</span>
                                                        <span class="payment-value"
                                                            style="color: <%= (order.paymentStatus === 'paid') ? '#198754' : '#fd7e14' %>">
                                                            <%= (order.paymentMethod==='COD' &&
                                                                order.paymentStatus==='paid' && !order.items.every(i=>
                                                                i.status === 'delivered')) ? 'Unpaid' :
                                                                order.paymentStatus %>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Items -->
                                        <div class="items-section">
                                            <div class="table-container">
                                                <table class="order-items-table">
                                                    <thead>
                                                        <tr>
                                                            <th>Product</th>
                                                            <th style="text-align: center;">Qty</th>
                                                            <th style="text-align: center;">Price</th>
                                                            <th style="text-align: center;">Total</th>
                                                            <th style="text-align: center;">Status</th>
                                                            <th style="text-align: right;">Action</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% order.items.forEach(item=> { %>
                                                            <tr>
                                                                <td data-label="Product">
                                                                    <div class="product-cell">
                                                                        <img src="<%= item.image %>"
                                                                            alt="<%= item.name %>" class="product-img">
                                                                        <div class="product-info">
                                                                            <p class="product-name">
                                                                                <%= item.name %>
                                                                            </p>
                                                                            <% if (item.label) { %>
                                                                                <p class="product-variant">Variant: <%=
                                                                                        item.label %>
                                                                                </p>
                                                                                <% } %>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td data-label="Qty" style="text-align: center;">x<%=
                                                                        item.productQuantity %>
                                                                </td>
                                                                <td data-label="Price" style="text-align: center;">₹<%=
                                                                        item.purchasedPrice.toLocaleString('en-IN') %>
                                                                </td>
                                                                <td data-label="Total"
                                                                    style="text-align: center; font-weight: 700;">₹<%=
                                                                        item.total.toLocaleString('en-IN') %>
                                                                </td>
                                                                <td data-label="Status" style="text-align: center;">
                                                                    <span
                                                                        class="status-badge status-<%= item.status.replace('_', '-') %>">
                                                                        <%= item.status.replace('_', ' ' ) %>
                                                                    </span>
                                                                </td>
                                                                <td data-label="Action" style="text-align: right;">
                                                                    <% if (['pending', 'confirmed'
                                                                        ].includes(item.status)) { %>
                                                                        <button
                                                                            onclick="handleItemAction('<%= order._id %>', '<%= item._id %>', 'cancel')"
                                                                            class="btn-action btn-cancel">
                                                                            Cancel
                                                                        </button>
                                                                        <% } else if (item.status==='delivered' ) { %>
                                                                            <button
                                                                                onclick="handleItemAction('<%= order._id %>', '<%= item._id %>', 'return')"
                                                                                class="btn-action btn-return">
                                                                                Return
                                                                            </button>
                                                                            <% } else if
                                                                                (item.status==='return_requested' ) { %>
                                                                                <span
                                                                                    style="font-size: 11px; color: #fd7e14; font-weight: 700;">RETURN
                                                                                    REQUESTED</span>
                                                                                <% } else { %>
                                                                                    <span
                                                                                        style="font-size: 11px; color: #adb5bd;">COMPLETED</span>
                                                                                    <% } %>
                                                                </td>
                                                            </tr>
                                                            <% }) %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <!-- Summary -->
                                        <div class="summary-footer">
                                            <div class="summary-box">
                                                <div class="summary-row">
                                                    <span>Subtotal</span>
                                                    <span style="font-weight: 600;">₹<%= (order.subtotal ||
                                                            order.totalAmount).toLocaleString('en-IN') %></span>
                                                </div>
                                                <div class="summary-row">
                                                    <span>Discount</span>
                                                    <span style="font-weight: 600; color: #198754;">-₹<%=
                                                            (order.discountAmount || 0).toLocaleString('en-IN') %>
                                                    </span>
                                                </div>
                                                <div class="summary-row total">
                                                    <span>Total</span>
                                                    <span class="grand-total">₹<%=
                                                            order.totalAmount.toLocaleString('en-IN') %></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </main>
                        </div>
                    </div>


                    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                    <script src="/js/users/orderDetails.js"></script>
                    <%- include('../partials/footer') %>
</body>

</html>